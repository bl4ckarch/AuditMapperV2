import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  X, 
  Save, 
  Target, 
  Terminal, 
  FileText, 
  Image as ImageIcon,
  AlertTriangle,
  Clock,
  Camera,
  Plus,
  Trash2
} from 'lucide-react';
import { createPortal } from 'react-dom';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { ExploitationStep } from '@/types';

interface ExploitationModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSave: (step: Omit<ExploitationStep, 'id'>) => void;
  editingStep?: ExploitationStep | null;
}

export const ExploitationModal: React.FC<ExploitationModalProps> = ({
  isOpen,
  onClose,
  onSave,
  editingStep,
}) => {
  const [step, setStep] = useState<Omit<ExploitationStep, 'id'>>({
    title: '',
    description: '',
    command: '',
    output: '',
    severity: 'Medium',
    status: 'pending',
    notes: '',
    screenshots: [],
    cve: '',
    cvss: undefined as any,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  });

  const [screenshotUrl, setScreenshotUrl] = useState('');

  useEffect(() => {
    if (editingStep) {
      setStep({
        title: editingStep.title,
        description: editingStep.description,
        command: editingStep.command || '',
        output: editingStep.output || '',
        severity: editingStep.severity,
        status: editingStep.status,
        notes: editingStep.notes || '',
        screenshots: editingStep.screenshots || [],
        cve: editingStep.cve || '',
        cvss: editingStep.cvss as any,
        createdAt: editingStep.createdAt,
        updatedAt: new Date().toISOString(),
      });
    } else {
      setStep({
        title: '',
        description: '',
        command: '',
        output: '',
        severity: 'Medium',
        status: 'pending',
        notes: '',
        screenshots: [],
        cve: '',
        cvss: undefined as any,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
      });
    }
  }, [editingStep, isOpen]);

  // Collage (Ctrl+V) d'images -> base64 compress√©
  const handlePaste = async (e: React.ClipboardEvent<HTMLDivElement>) => {
    const items = e.clipboardData?.items;
    if (!items) return;
    for (const item of items) {
      if (item.type.indexOf('image') !== -1) {
        e.preventDefault();
        const file = item.getAsFile();
        if (file) {
          const base64 = await fileToOptimizedBase64(file, 0.7, 1280, 800);
          setStep(prev => ({ ...prev, screenshots: [...(prev.screenshots || []), base64] }));
        }
      }
    }
  };

  const handleDrop = async (e: React.DragEvent<HTMLDivElement>) => {
    e.preventDefault();
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
    for (const file of files) {
      const base64 = await fileToOptimizedBase64(file, 0.7, 1280, 800);
      setStep(prev => ({ ...prev, screenshots: [...(prev.screenshots || []), base64] }));
    }
  };

  const fileToOptimizedBase64 = (file: File, quality = 0.7, maxW = 1280, maxH = 800): Promise<string> => {
    return new Promise((resolve) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = () => {
        img.onload = () => {
          const canvas = document.createElement('canvas');
          let w = img.width, h = img.height;
          if (w > maxW) { h = Math.floor(h * (maxW / w)); w = maxW; }
          if (h > maxH) { w = Math.floor(w * (maxH / h)); h = maxH; }
          canvas.width = w; canvas.height = h;
          const ctx = canvas.getContext('2d');
          if (ctx) {
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(img, 0, 0, w, h);
            const base64 = canvas.toDataURL('image/jpeg', quality);
            resolve(base64);
          } else {
            resolve(reader.result as string);
          }
        };
        img.src = reader.result as string;
      };
      reader.readAsDataURL(file);
    });
  };

  const addScreenshot = () => {
    if (screenshotUrl.trim()) {
      setStep(prev => ({
        ...prev,
        screenshots: [...prev.screenshots, screenshotUrl.trim()]
      }));
      setScreenshotUrl('');
    }
  };

  const removeScreenshot = (index: number) => {
    setStep(prev => ({
      ...prev,
      screenshots: prev.screenshots.filter((_, i) => i !== index)
    }));
  };

  const handleSave = () => {
    if (!step.title.trim()) return;
    onSave({ ...step, updatedAt: new Date().toISOString() });
    onClose();
  };

  if (!isOpen) return null;

  const modal = (
    <AnimatePresence>
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        className="fixed inset-0 z-[9999] bg-slate-900/85 backdrop-blur-sm flex items-center justify-center p-4"
        onClick={(e) => e.target === e.currentTarget && onClose()}
        onPaste={handlePaste}
        onDrop={handleDrop}
        onDragOver={(e) => e.preventDefault()}
      >
        <motion.div
          initial={{ scale: 0.95, opacity: 0 }}
          animate={{ scale: 1, opacity: 1 }}
          exit={{ scale: 0.95, opacity: 0 }}
          className="w-[92vw] max-w-5xl h-[88vh] bg-slate-800 rounded-lg border border-slate-700 overflow-hidden flex flex-col m-4"
        >
          {/* Header */}
          <div className="flex items-center justify-between p-6 border-b border-slate-700 bg-gradient-to-r from-slate-800 to-slate-700">
            <div className="flex items-center gap-3">
              <Target className="w-6 h-6 text-red-400" />
              <div>
                <h2 className="text-xl font-semibold text-slate-100">
                  {editingStep ? 'Modifier l\'√©tape d\'exploitation' : 'Nouvelle √©tape d\'exploitation'}
                </h2>
                <p className="text-sm text-slate-400">Documentez vos techniques, POC, captures et r√©sultats</p>
              </div>
            </div>
            <Button
              variant="outline"
              size="sm"
              onClick={onClose}
              className="bg-slate-700 border-slate-600 text-slate-200 hover:bg-slate-600"
            >
              <X className="w-4 h-4" />
            </Button>
          </div>

          {/* Content */}
          <div className="flex-1 overflow-auto p-6">
            <div className="space-y-6">
              {/* Basic Info */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    <Target className="w-4 h-4 inline mr-2" />
                    Titre de l'√©tape *
                  </label>
                  <Input
                    value={step.title}
                    onChange={(e) => setStep(prev => ({ ...prev, title: e.target.value }))}
                    className="bg-slate-700 border-slate-600 text-slate-100"
                    placeholder="Ex: Exploitation RCE via SQL injection"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    <AlertTriangle className="w-4 h-4 inline mr-2" />
                    S√©v√©rit√©
                  </label>
                  <Select value={step.severity} onValueChange={(value: any) => setStep(prev => ({ ...prev, severity: value }))}>
                    <SelectTrigger className="bg-slate-700 border-slate-600 text-slate-100">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent className="bg-slate-700 border-slate-600">
                      <SelectItem value="Low" className="text-green-400">üü¢ Faible</SelectItem>
                      <SelectItem value="Medium" className="text-yellow-400">üü° Moyenne</SelectItem>
                      <SelectItem value="High" className="text-orange-400">üü† √âlev√©e</SelectItem>
                      <SelectItem value="Critical" className="text-red-400">üî¥ Critique</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    <Clock className="w-4 h-4 inline mr-2" />
                    Statut
                  </label>
                  <Select value={step.status} onValueChange={(value: any) => setStep(prev => ({ ...prev, status: value }))}>
                    <SelectTrigger className="bg-slate-700 border-slate-600 text-slate-100">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent className="bg-slate-700 border-slate-600">
                      <SelectItem value="pending">‚è≥ En attente</SelectItem>
                      <SelectItem value="in_progress">üîÑ En cours</SelectItem>
                      <SelectItem value="completed">‚úÖ Termin√©</SelectItem>
                      <SelectItem value="failed">‚ùå √âchou√©</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">CVE</label>
                  <Input
                    value={step.cve || ''}
                    onChange={(e) => setStep(prev => ({ ...prev, cve: e.target.value }))}
                    className="bg-slate-700 border-slate-600 text-slate-100"
                    placeholder="Ex: CVE-2021-44228"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">CVSS</label>
                  <Input
                    type="number"
                    value={step.cvss ?? ''}
                    onChange={(e) => setStep(prev => ({ ...prev, cvss: e.target.value === '' ? undefined as any : Number(e.target.value) }))}
                    className="bg-slate-700 border-slate-600 text-slate-100"
                    placeholder="Ex: 9.8"
                  />
                </div>
              </div>

              {/* Description */}
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  <FileText className="w-4 h-4 inline mr-2" />
                  Description d√©taill√©e
                </label>
                <Textarea
                  value={step.description}
                  onChange={(e) => setStep(prev => ({ ...prev, description: e.target.value }))}
                  className="bg-slate-700 border-slate-600 text-slate-100 min-h-[100px]"
                  placeholder={`Contexte, conditions, vecteur d'attaque, hypoth√®ses, etc.`}
                />
              </div>

              {/* Command & Output */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    <Terminal className="w-4 h-4 inline mr-2" />
                    Commande d'exploitation
                  </label>
                  <Textarea
                    value={step.command}
                    onChange={(e) => setStep(prev => ({ ...prev, command: e.target.value }))}
                    className="bg-slate-900 border-slate-600 text-green-400 font-mono text-sm min-h-[120px]"
                    placeholder={`sqlmap -u 'http://target/vuln?id=1' --risk=3 --level=5 --batch`}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-300 mb-2">
                    <Terminal className="w-4 h-4 inline mr-2" />
                    Output / R√©sultat
                  </label>
                  <Textarea
                    value={step.output}
                    onChange={(e) => setStep(prev => ({ ...prev, output: e.target.value }))}
                    className="bg-slate-900 border-slate-600 text-slate-300 font-mono text-sm min-h-[120px]"
                    placeholder="[INFO] Param√®tre 'id' vuln√©rable √† SQLi..."
                  />
                </div>
              </div>

              {/* Screenshots */}
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  <Camera className="w-4 h-4 inline mr-2" />
                  Screenshots de preuve
                </label>

                <div className="flex gap-2 mb-3">
                  <Input
                    value={screenshotUrl}
                    onChange={(e) => setScreenshotUrl(e.target.value)}
                    className="bg-slate-700 border-slate-600 text-slate-100"
                    placeholder="URL de l'image ou chemin local... (ou collez directement une image)"
                  />
                  <Button onClick={addScreenshot} disabled={!screenshotUrl.trim()} className="bg-blue-600 hover:bg-blue-700">
                    <Plus className="w-4 h-4" />
                  </Button>
                </div>

                <div
                  className="border border-dashed border-slate-600 rounded p-4 text-slate-400 text-sm mb-3"
                >
                  Glissez-d√©posez des images ici ou utilisez Ctrl+V pour coller
                </div>

                {step.screenshots.length > 0 && (
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {step.screenshots.map((screenshot, index) => (
                      <div key={index} className="relative group">
                        <img
                          src={screenshot}
                          alt={`Screenshot ${index + 1}`}
                          className="w-full h-24 object-cover rounded border border-slate-600"
                          onError={(e) => {
                            (e.currentTarget as HTMLImageElement).src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDIwMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMTIwIiBmaWxsPSIjMzM0MTU1Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5QTBCOCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vbiB0cm91dsOpZTwvdGV4dD4KPC9zdmc+';
                          }}
                        />
                        <Button
                          onClick={() => removeScreenshot(index)}
                          className="absolute top-1 right-1 w-6 h-6 p-0 bg-red-600 hover:bg-red-700 opacity-0 group-hover:opacity-100 transition-opacity"
                        >
                          <Trash2 className="w-3 h-3" />
                        </Button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Notes */}
              <div>
                <label className="block text-sm font-medium text-slate-300 mb-2">
                  <FileText className="w-4 h-4 inline mr-2" />
                  Notes suppl√©mentaires
                </label>
                <Textarea
                  value={step.notes}
                  onChange={(e) => setStep(prev => ({ ...prev, notes: e.target.value }))}
                  className="bg-slate-700 border-slate-600 text-slate-100 min-h-[80px]"
                  placeholder={`Impact, rem√©diation, r√©f√©rences, etc.`}
                />
              </div>
            </div>
          </div>

          {/* Footer */}
          <div className="flex items-center justify-between p-6 border-t border-slate-700 bg-slate-800/80">
            <div className="text-sm text-slate-400">
              {editingStep ? 'Modification d\'une √©tape existante' : 'Cr√©ation d\'une nouvelle √©tape'}
            </div>
            <div className="flex items-center gap-3">
              <Button variant="outline" onClick={onClose} className="bg-slate-700 border-slate-600 text-slate-200 hover:bg-slate-600">
                Annuler
              </Button>
              <Button onClick={handleSave} disabled={!step.title.trim()} className="bg-blue-600 hover:bg-blue-700 disabled:opacity-50">
                <Save className="w-4 h-4 mr-2" />
                {editingStep ? 'Modifier' : 'Cr√©er'} l'√©tape
              </Button>
            </div>
          </div>
        </motion.div>
      </motion.div>
    </AnimatePresence>
  );

  return createPortal(modal, document.body);
};
